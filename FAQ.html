<html><head><title>thomas: FAQ</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="@kailuowang" /><meta name="description" content="Thomas, a library for A/B tests" /><meta name="og:image" content="/thomas/img/poster.png" /><meta name="image" property="og:image" content="/thomas/img/poster.png" /><meta name="og:title" content="thomas: FAQ" /><meta name="title" property="og:title" content="thomas: FAQ" /><meta name="og:site_name" content="thomas" /><meta name="og:url" content="https://github.com/iheartradio/thomas" /><meta name="og:type" content="website" /><meta name="og:description" content="Thomas, a library for A/B tests" /><link rel="icon" type="image/png" href="/thomas/img/favicon.png" /><meta name="twitter:title" content="thomas: FAQ" /><meta name="twitter:image" content="/thomas/img/poster.png" /><meta name="twitter:description" content="Thomas, a library for A/B tests" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/thomas/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/thomas/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/thomas/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/thomas/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/thomas/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/thomas/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/thomas/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/thomas/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/thomas/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/thomas/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/thomas/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/thomas/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/thomas/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/thomas/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/thomas/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/thomas/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/thomas/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/thomas/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/thomas/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/thomas/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/thomas/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/thomas/css/style.css" /><link rel="stylesheet" href="/thomas/css/palette.css" /><link rel="stylesheet" href="/thomas/css/codemirror.css" /></head><body><header id="site-header"><div class="navbar-wrapper navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/thomas/" class="brand"><div class="icon-wrapper"><span>thomas</span></div></a></div><nav class="text-right"><ul class=""><li><a href="https://github.com/iheartradio/thomas"><i class="fa fa-github"></i><span class="hidden-xs">GitHub</span></a></li><li><a href="/thomas/api/com/iheart/thomas/index.html"><i class="fa fa-file-text"></i><span class="hidden-xs">API Documentation</span></a></li></ul></nav></div></div><div class="jumbotron" style="background-image:url('/thomas/img/jumbotron_pattern.png')"></div><div><ul class="horizontalNav">     <li><a class="" href="/thomas/">Home</a></li>  <li><a class="" href="/thomas/get-started.html">Get Started</a></li>  <li><a class="" href="/thomas/core.html">Core concepts</a></li>  <li><a class=" active " href="/thomas/FAQ.html">FAQ</a></li>  <li><a class="" href="/thomas/bayesian.html">Bayesian Analysis</a></li> </ul></div></header><main id="site-main"><section class="use"><div class="container"><div id="content"><h1 id="content-table">Content Table</h1>

<ul>
  <li><a href="#how-to-add-an-override">How to add an override</a></li>
  <li><a href="#how-to-get-the-test-id">How to get the test Id</a></li>
  <li><a href="#how-to-terminate-an-ab-test">How to terminate an A/B test</a></li>
  <li><a href="#how-to-do-a-feature-roll-out">How to do a feature roll out</a></li>
  <li><a href="#how-to-run-distributed-group-assignments">How to run distributed group assignments</a></li>
  <li><a href="#how-to-run-bayesian-analysis">How to run Bayesian Analysis</a></li>
</ul>

<h3 id="all-methods-in-api-have-corresponding-endpoints-in-http-service-library-play-or-http4s">All methods in API have corresponding endpoints in http service library (play or http4s).</h3>

<h1 id="how-do-i-fix-a-user-to-a-certain-group-so-that-i-can-test-the-treatment">How do I fix a user to a certain group so that I can test the treatment</h1>

<p>You can use the override feature to add overrides which are pairs of user Id and group name. 
<a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#getOverrides(featureName:com.iheart.thomas.model.FeatureName):F[com.iheart.thomas.model.Feature]">API for adding overides</a></p>

<h1 id="how-to-get-the-test-id">How to get the test ID</h1>

<p>A/B tests are organized around “feature”s, you can run multiple A/B tests for the same feature, they just can’t be scheduled to have any overlap with each other. For each test, there is a test Id which is generated when you created it. If you need the test Id for a specific test, you can use <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#getTestsByFeature(feature:com.iheart.thomas.model.FeatureName):F[Vector[lihua.Entity[com.iheart.thomas.model.Abtest]]]">this method</a> which, and will respond with a list of all tests against this feature. In the list you can find more details of the tests including the test Id.</p>

<h1 id="how-to-terminatedelete-an-ab-test">How to terminate/delete an A/B test</h1>

<p>You would need the testId to use <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#terminate(test:com.iheart.thomas.model.TestId):F[Option[lihua.Entity[com.iheart.thomas.model.Abtest]]]">this method</a>. If a test already started, the test will be expired immediately. If the test is schedule to run in the future, it will be removed from the database.</p>

<h1 id="how-to-do-a-feature-roll-out">How to do a feature roll out</h1>

<p>You can use A/B test service to gradually roll out feature by incrementing the experiment group size in a series of tests. 
You start the first test without an end date, this will make the test run indefinitely. 
To gradually increase of experiment group size, use the <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#continue(spec:com.iheart.thomas.model.AbtestSpec):F[lihua.Entity[com.iheart.thomas.model.Abtest]]">continue method</a> to create subsequent tests (all without end date), with larger and larger experiment group sizes, until you reach 100%.</p>

<h1 id="how-to-run-distributed-group-assignments">How to run distributed group assignments</h1>

<p>Thomas provides a thomas-client that can pull down experiments metadata and calculate user assignments in parallel on local CPUs. It provides a <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/client/JavaAssignments.html">Java API class</a> so that it can be easily used in Java application or pyspark. To run it in pyspark,</p>
<div class="highlighter-rouge"><pre class="highlight"><code>pyspark --packages com.iheart:thomas-client_2.11:LATEST_VERSION
</code></pre>
</div>
<p><a href="https://github.com/iheartradio/thomas/releases">Check here for the latest version</a> to use in place of <code class="highlighter-rouge">LATEST_VERSION</code></p>

<p>Then in pyspark you can run</p>
<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">client</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">iheart</span><span class="o">.</span><span class="n">thomas</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">JavaAssignment</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">"http://myhost/testsWithFeatures"</span><span class="p">,</span> <span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">assignments</span><span class="p">(</span><span class="s">"813579"</span><span class="p">,</span> <span class="p">[</span><span class="s">"Feature_forYouBanner"</span><span class="p">],</span> <span class="p">{</span><span class="s">"deviceId"</span><span class="p">:</span> <span class="s">"ax3263sdx11"</span><span class="p">})</span>  

</code></pre>
</div>
<p>The first line creates the <code class="highlighter-rouge">client</code>, using <code class="highlighter-rouge">com.iheart.thomas.client.JavaAssignment.create</code>, you need to pass in a url string pointing to the endpoint corresponding to <a href="https://iheartradio.github.io/thomas/api/com/iheart/thomas/API.html#getAllTestsCachedEpoch(time:Option[Long]):F[Vector[(lihua.Entity[com.iheart.thomas.model.Abtest],com.iheart.thomas.model.Feature)]]">this API method</a> (on play, if you follow the xample, it will be “yourHost/testsWithFeatures”, on http4s it will be “yourHost/tests/cache”).  You can also pass in a second optional argument - a timestamp for the as-of time for your assignments. For example, if you want to return assignments as of tomorrow 12:00PM, you need to get the epoch second time stamp of that time and pass in. You should reuse this <code class="highlighter-rouge">client</code> in your session, during the creation it makes an http call to the thomas A/B test http service and 
download all the relevant tests and overrides. So please avoid recreating it unnecessarily.</p>

<p><code class="highlighter-rouge">client.assignments(userId, [tags], {user_meta})</code>  returns a Map (or hashmap if you are in python) of assignments. The keys of this Map will be feature names, and the values are the group names, the second and third arguments <code class="highlighter-rouge">[tags]</code> and <code class="highlighter-rouge"><span class="p">{</span><span class="err">user_meta</span><span class="p">}</span></code> are optional, ignore them if your tests don’t requirement them.</p>

<p>This solution works fine for pyspark with small amount of data. For large dataset, Pyspark introp with JVM is not efficient.</p>

<p>Thomas also provides a tighter spark integration module <code class="highlighter-rouge">thomas-spark</code>, which provides an UDF and a function that works directly with 
DataFrame. The assignment computation is distributed through UDF</p>

<p>Here is an example on how to use this in pyspark:
Start spark with the package</p>

<p><code class="highlighter-rouge">pyspark --packages com.iheart:thomas-spark_2.11:LATEST_VERSION</code></p>

<p>Inside pyspark shell, first create the instance of an A/B test <code class="highlighter-rouge">Assigner</code></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">ta</span> <span class="o">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">_jvm</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">iheart</span><span class="o">.</span><span class="n">thomas</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">Assigner</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="s">"https://MY_ABTEST_SERVICE_HOST/abtest/testsWithFeatures"</span><span class="p">)</span>
</code></pre>
</div>

<p>Then you can use it add a column to an existing <code class="highlighter-rouge">DataFrame</code></p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.mllib.common</span> <span class="kn">import</span> <span class="n">_py2java</span>
<span class="kn">from</span> <span class="nn">pyspark.mllib.common</span> <span class="kn">import</span> <span class="n">_java2py</span>


<span class="n">mockUserIds</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([(</span><span class="s">"232"</span><span class="p">,),</span> <span class="p">(</span><span class="s">"3609"</span><span class="p">,),</span> <span class="p">(</span><span class="s">"3423"</span><span class="p">,)],</span> <span class="p">[</span><span class="s">"uid"</span><span class="p">])</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">_java2py</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">assignments</span><span class="p">(</span><span class="n">_py2java</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">mockUserIds</span><span class="p">),</span> <span class="s">"My_Test_Feature"</span><span class="p">,</span> <span class="s">"uid"</span><span class="p">))</span>

</code></pre>
</div>

<p>Note that some python to java conversion is needed since <code class="highlighter-rouge">thomas-spark</code> is written in Scala.</p>

<p>The  <code class="highlighter-rouge">Assigner</code> also provides a Spark UDF <code class="highlighter-rouge">assignUdf</code>. You can call it with a feature name to 
get an UDF that returns the assignment for that abtest feature.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code>
<span class="n">spark</span><span class="o">.</span><span class="n">_jsparkSession</span><span class="o">.</span><span class="n">udf</span><span class="p">()</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">"assign"</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">assignUdf</span><span class="p">(</span><span class="s">"My_TEST_FEATURES"</span><span class="p">))</span>

<span class="n">sqlContext</span><span class="o">.</span><span class="n">registerDataFrameAsTable</span><span class="p">(</span><span class="n">mockUserIds</span><span class="p">,</span> <span class="s">"userIds"</span><span class="p">)</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">sql</span><span class="p">(</span><span class="s">"select uid, assign(uid) as assignment from userIds"</span><span class="p">)</span>

</code></pre>
</div>

<p>Or instead of registering the udf, you can use it through a python function</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="kn">import</span> <span class="n">_to_java_column</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.column</span> <span class="kn">import</span> <span class="n">_to_seq</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>

<span class="k">def</span> <span class="nf">assign</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
    <span class="n">_javaAssign</span> <span class="o">=</span> <span class="n">ta</span><span class="o">.</span><span class="n">assignUdf</span><span class="p">(</span><span class="s">"My_TEST_FEATURES"</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Column</span><span class="p">(</span><span class="n">_javaAssign</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="n">_to_seq</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">_to_java_column</span><span class="p">)))</span>

<span class="n">mockUserIds</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s">'assignment'</span><span class="p">,</span> <span class="n">assign</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s">'uid'</span><span class="p">)))</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

</code></pre>
</div>

<p>In scala, it’s more straightforward.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">spark.implicits._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions.col</span>

<span class="k">val</span> <span class="n">mockUserIds</span> <span class="k">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">10000</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)</span>

<span class="k">val</span> <span class="n">assigner</span> <span class="k">=</span> <span class="n">com</span><span class="o">.</span><span class="n">iheart</span><span class="o">.</span><span class="n">thomas</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="nc">Assigner</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="s">"https://MY_ABTEST_SERVICE_HOST/abtest/testsWithFeatures"</span><span class="o">)</span>


<span class="n">mockUserIds</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">"assignment"</span><span class="o">,</span> <span class="n">assigner</span><span class="o">.</span><span class="n">assignUdf</span><span class="o">(</span><span class="s">"My_TEST_FEATURES"</span><span class="o">)(</span><span class="n">col</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)))</span>

</code></pre>
</div>

<p><code class="highlighter-rouge">assigner.assignUdf</code> assigns based on the test data it retrieves when it’s created from <code class="highlighter-rouge">Assigner.create</code>. 
If you have a long running job, e.g. in Spark stream, you might want a <code class="highlighter-rouge">udf</code> that keeps test data updated, 
so that over a longer period of time it keeps assigning based on latest test data from server. 
In that case, you can use the <code class="highlighter-rouge">com.iheart.thomas.AutoRefreshAssigner</code></p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">concurrent.duration._</span>

<span class="k">val</span> <span class="n">assigner</span> <span class="k">=</span> <span class="n">com</span><span class="o">.</span><span class="n">iheart</span><span class="o">.</span><span class="n">thomas</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="nc">AutoRefreshAssigner</span><span class="o">(</span>
  <span class="n">url</span> <span class="k">=</span> <span class="s">"https://MY_ABTEST_SERVICE_HOST/abtest/testsWithFeatures"</span><span class="o">,</span> 
  <span class="n">refreshPeriod</span> <span class="k">=</span> <span class="mf">10.</span><span class="n">minutes</span> 
<span class="o">)</span>

<span class="n">mockUserIds</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">"assignment"</span><span class="o">,</span> <span class="n">assigner</span><span class="o">.</span><span class="n">assignUdf</span><span class="o">(</span><span class="s">"My_TEST_FEATURES"</span><span class="o">)(</span><span class="n">col</span><span class="o">(</span><span class="s">"userId"</span><span class="o">)))</span>

</code></pre>
</div>
<p>The <code class="highlighter-rouge">refreshPeriod</code> dictates how often the test data is retrieved from the A/B test service per spark partition.</p>

<h1 id="how-to-run-bayesian-analysis">How to run Bayesian Analysis</h1>

<p>Since Thomas does not come with an analytics solution, to analyze the A/B test results using Thomas’s Bayesian utility, you need to write integration with your analytics solution. Please refer to <a href="bayesian.html">the dedicated page</a> for detailed guide on this one.</p>
</div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><div class="col-xs-6"><p>thomas is designed and developed by <a href="https://github.com/iheartradio/thomas" target="_blank" rel="noopener noreferrer">@kailuowang</a></p></div><div class="col-xs-6"><p class="text-right"><a href="https://github.com/iheartradio/thomas"><span class="fa fa-github"></span>View on GitHub</a></p></div></div><div class="row"><div class="col-xs-6"><p>Website built with <a href="https://47deg.github.io/sbt-microsites/" target="_blank" rel="noopener noreferrer">sbt-microsites</a> - © 2019 <a href="https://www.47deg.com/" target="_blank" rel="noopener noreferrer">47 Degrees</a></p></div></div><script src="/thomas/highlight/highlight.pack.js"></script><script>hljs.initHighlighting();
              </script></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/thomas/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlighting();
              </script><script>((window.gitter = {}).chat = {}).options = {
room: 'iheartradio/thomas'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script></body></html>